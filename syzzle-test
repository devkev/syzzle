#!/bin/bash

#
# Functional and unit tests for syz
#


if [ "$1" != real ]; then
	unset SYZ_{PATH,MODULES,MODULES_ABS,INACTIVE_MODULES}
	exec time bash --norc "$0" real "$@"
fi
shift # eat the "real"

for i; do
	case "$i" in
		-v)
			verbose=y
			;;
		-q)
			quiet=y
			;;
	esac
done
unset i

# Setup

basedir=""
trap '__syz_rc="$?" ; set +ex ; echo ; if [ $__syz_rc = 0 ]; then echo "ALL TESTS PASSED"; else echo "TEST FAILED ($__syz_rc)"; fi ; [ "$basedir" ] && rm -rf "$basedir" ; exit $__syz_rc' EXIT
basedir="${SYZZLE_TEST_BASEDIR:-$(mktemp -d)}"
if [ ! -e "$basedir" ]; then
	mkdir -p "$basedir"
fi
__syz_tmpfile="$basedir/tmpfile"

nl='
'
test_pvs=""
for i in {abc,def,ghi,jkl}/{1.0,1.1,1.2,1.3}; do
	test_pvs="$test_pvs$i$nl"
done
unset i
test_pvs="${test_pvs%$nl}"
#echo "$test_pvs"
export SYZ_PATH="$basedir/sw"

__syz_marker="+"

function indent {
	__syz_marker="$__syz_marker+"
}

function unindent {
	__syz_marker="${__syz_marker%+}"
}

if [ "$quiet" = y ]; then

	# This function based on https://github.com/fearside/ProgressBar/blob/master/progressbar.sh
	function _progress_bar {
		local msg="$1" ; shift
		local sofar="$1" ; shift
		local total="$1" ; shift

		local -i progress=($sofar*100/$total*100)/100
		local -i done=(${progress}*4)/10
		local -i left=40-$done

		# Build progressbar string lengths
		local donestr=$(printf "%${done}s")
		local leftstr=$(printf "%${left}s")

		# eg: Progress : [########################################] 100%
		echo -ne "\r$msg: [${donestr// /#}${leftstr// /-}] ${progress}%"
	}

	tests_start="$(awk '$0 == "msg prelim" { print NR; exit }' "$0")"
	total_lines="$(( $(wc -l "$0" | awk '{print$1}') - $tests_start ))"

	function blankline {
		local current_line="$(( ${BASH_LINENO[$((${#BASH_LINENO[@]}-2))]} - $tests_start ))"
		#echo "$current_line/$total_lines"
		_progress_bar "Running tests" $current_line $total_lines
	}

	function msg {
		:
	}

	_progress_bar "Running tests" 0 $total_lines

else
	function blankline {
		echo
	}

	function msg {
		echo "$__syz_marker $*"
	}
fi

function do_run {
	indent
	msg "${FUNCNAME[0]} $*"
	"$@" > "$__syz_tmpfile"
	__syz_rc="$?"
	__syz_o="$(<"$__syz_tmpfile")"
	if [ "$verbose" = y ]; then
		indent
		msg "rc=$__syz_rc"
		msg "---- start output ----"
		if [ "$__syz_o" ]; then
			echo "$__syz_o"
		fi
		msg "---- end output ----"
		unindent
	fi
	unindent
}

function run {
	indent
	check no_leaked_vars --setup
	check no_leaked_aliases --setup
	do_run "$@"
	check no_leaked_vars
	check no_leaked_aliases
	unindent
}

function via_tty {
	indent
	msg "${FUNCNAME[0]} $*"
	function tty {
		:
	}
	"$@"
	unset -f tty
	unindent
}


function check {
	local __syz_what="$1" ; shift
	indent
	set -e
	check_"$__syz_what" "$@"
	set +e
	unindent
}

function check_success {
	msg "${FUNCNAME[0]}"
	[ "$__syz_rc" = "0" ]
}

function check_failure {
	local code="$1"
	msg "${FUNCNAME[0]} $code"
	if [ "$code" ]; then
		[ "$__syz_rc" = "$code" ]
	else
		[ "$__syz_rc" != "0" ]
	fi
}

function check_output_pattern {
	local i
	for i; do
		msg "${FUNCNAME[0]} $i"
		grep -q "$i" <<<"$__syz_o"
	done
}

function check_output_not_pattern {
	local i
	for i; do
		msg "${FUNCNAME[0]} $i"
		! grep -q "$i" <<<"$__syz_o"
	done
}

function check_output_exact {
	local target="$1" ; shift
	msg "${FUNCNAME[0]}"
	[ "$__syz_o" = "$target" ]
}

function check_envvar_pattern {
	local var="$1" ; shift
	local pattern
	for pattern; do
		local -n value="$var"
		msg "${FUNCNAME[0]} $var $pattern"
		grep -q "$pattern" <<<"$value"
	done
}

function check_envvar_not_pattern {
	local var="$1" ; shift
	local pattern
	for pattern; do
		local -n value="$var"
		msg "${FUNCNAME[0]} $var $pattern"
		! grep -q "$pattern" <<<"$value"
	done
}

function check_envvar_exact {
	local var="$1" ; shift
	local target="$1" ; shift
	local -n value="$var"
	msg "${FUNCNAME[0]} $var"
	[ "$value" = "$target" ]
}

function check_envvar_set {
	local i
	for i; do
		msg "${FUNCNAME[0]} $i"
		[ "${!i+set}" = "set" ]
	done
}

function check_envvar_unset {
	local i
	for i; do
		msg "${FUNCNAME[0]} $i"
		[ "${!i+set}" != "set" ]
	done
}

function check_no_modules_loaded {
	msg "${FUNCNAME[0]}"
	run syz loaded
	check success
	check output_exact ""
	via_tty run syz loaded
	check success
	check output_pattern 'No modules currently loaded\.'
}

function check_no_modules_inactive {
	msg "${FUNCNAME[0]}"
	run syz inactive
	check success
	check output_exact ""
	via_tty run syz inactive
	check success
	check output_pattern 'No inactive modules\.'
}

function check_modules_loaded {
	local i
	for i; do
		msg "${FUNCNAME[0]} $i"
		run syz loaded
		check success
		check output_pattern "^$i$"
		via_tty run syz loaded
		check success
		check output_pattern 'Currently loaded modules'
		check output_pattern "\<$i\>"
		run syz isloaded "$i"
		check success
		check output_exact "$i loaded"
	done
}

function check_modules_not_loaded {
	local i
	for i; do
		msg "${FUNCNAME[0]} $i"
		run syz loaded
		check success
		check output_not_pattern "^$i$"
		via_tty run syz loaded
		check success
		check output_not_pattern "\<$i\>"
		run syz isloaded "$i"
		check success
		check output_exact "$i not loaded"
	done
}

# generically catch any leaked environment vars.
# exclude: uppercase, starts with "__syz_", and the "_" variable.
function check_no_leaked_vars {
	if [ "$1" = "--setup" ]; then
		declare -p $(compgen -v -o default | grep -Ev '^[A-Z]|^__syz_|^_$') > "$__syz_tmpfile"
		declare -g __syz_vars_before="$(<"$__syz_tmpfile")"
	else
		msg "${FUNCNAME[0]}"
		declare -p $(compgen -v -o default | grep -Ev '^[A-Z]|^__syz_|^_$') > "$__syz_tmpfile"
		local __syz_vars_after="$(<"$__syz_tmpfile")"
		if [ "$verbose" = y ]; then
			indent
			msg "---- start vars_before ----"
			if [ "$__syz_vars_before" ]; then
				echo "$__syz_vars_before"
			fi
			msg "---- end vars_before ----"
			msg "---- start vars_after ----"
			if [ "$__syz_vars_after" ]; then
				echo "$__syz_vars_after"
			fi
			msg "---- end vars_after ----"
			unindent
		fi
		[ "$__syz_vars_before" = "$__syz_vars_after" ]
	fi
}

function check_no_leaked_aliases {
	if [ "$1" = "--setup" ]; then
		local old_rc="$__syz_rc"
		local old_o="$__syz_o"
		do_run alias -p
		declare -g __syz_aliases_before="$__syz_o"
		__syz_rc="$old_rc"
		__syz_o="$old_o"
	else
		msg "${FUNCNAME[0]}"
		local old_rc="$__syz_rc"
		local old_o="$__syz_o"
		do_run alias -p
		check output_exact "$__syz_aliases_before"
		__syz_rc="$old_rc"
		__syz_o="$old_o"
	fi
}

msg prelim
check envvar_pattern "SYZ_PATH" '^'"$basedir"'/sw$'
check envvar_unset SYZ_{MODULES,MODULES_ABS,INACTIVE_MODULES}

check no_leaked_vars --setup
check no_leaked_aliases --setup

blankline
msg "load"
set -e
. ./syzzle
set +e

check no_leaked_vars
check no_leaked_aliases

check envvar_pattern "SYZ_VERSION" '.'
check envvar_pattern "SYZ_PATH" '^'"$basedir"'/sw$'
check envvar_set SYZ_{MODULES,MODULES_ABS,INACTIVE_MODULES}
check envvar_exact "SYZ_MODULES" ''
check envvar_exact "SYZ_MODULES_ABS" ''
check envvar_exact "SYZ_INACTIVE_MODULES" ''

blankline
run syz avail
check success
check output_exact ''
via_tty run syz avail
check success
check output_exact 'No modules available.'

for i in $test_pvs; do
	mkdir -p "$basedir/sw/$i"/{bin,lib}
done
unset i
# FIXME: current and default symlinks

blankline
run syz avail
check success
check output_exact "$test_pvs"
via_tty run syz avail
check success
check output_pattern 'Available modules'
check output_pattern $test_pvs

blankline
run syz version
check success
check output_pattern "version" "$SYZ_VERSION"

blankline
run syz empty
check success
__syz_o_empty="$__syz_o"
run syz
check success
check output_exact "$__syz_o_empty"
run syz status
check success
check output_exact "$__syz_o_empty"

blankline
run syz show
check success
__syz_o_show="$__syz_o"

blankline
check modules_not_loaded 'abc/1.0'
check modules_not_loaded 'def/1.1'
check modules_not_loaded 'ghi/1.2'
check no_modules_loaded
check no_modules_inactive

blankline
run syz load abc/1.0
check success
check output_pattern 'Loading' 'abc/1.0'
check envvar_pattern 'SYZ_MODULES' 'abc/1.0'
check envvar_pattern 'SYZ_MODULES_ABS' "$basedir"/sw/abc/1.0
check envvar_pattern 'PATH' "$basedir"/sw/abc/1.0/bin
check envvar_pattern 'LIBRARY_PATH' "$basedir"/sw/abc/1.0/lib
check envvar_pattern 'LD_LIBRARY_PATH' "$basedir"/sw/abc/1.0/lib
check envvar_pattern 'LD_RUN_PATH' "$basedir"/sw/abc/1.0/lib

check modules_loaded 'abc/1.0'
check modules_not_loaded 'def/1.1'
check modules_not_loaded 'ghi/1.2'
check no_modules_inactive

blankline
run syz load def/1.1
check success
check output_pattern 'Loading' 'def/1.1'
check envvar_pattern 'SYZ_MODULES' 'def/1.1'
check envvar_pattern 'SYZ_MODULES_ABS' "$basedir"/sw/def/1.1
check envvar_pattern 'PATH' "$basedir"/sw/def/1.1/bin
check envvar_pattern 'LIBRARY_PATH' "$basedir"/sw/def/1.1/lib
check envvar_pattern 'LD_LIBRARY_PATH' "$basedir"/sw/def/1.1/lib
check envvar_pattern 'LD_RUN_PATH' "$basedir"/sw/def/1.1/lib

check modules_loaded 'abc/1.0'
check modules_loaded 'def/1.1'
check modules_not_loaded 'ghi/1.2'
check no_modules_inactive

blankline
run syz load ghi/1.2
check success
check output_pattern 'Loading' 'ghi/1.2'
check envvar_pattern 'SYZ_MODULES' 'ghi/1.2'
check envvar_pattern 'SYZ_MODULES_ABS' "$basedir"/sw/ghi/1.2
check envvar_pattern 'PATH' "$basedir"/sw/ghi/1.2/bin
check envvar_pattern 'LIBRARY_PATH' "$basedir"/sw/ghi/1.2/lib
check envvar_pattern 'LD_LIBRARY_PATH' "$basedir"/sw/ghi/1.2/lib
check envvar_pattern 'LD_RUN_PATH' "$basedir"/sw/ghi/1.2/lib

check modules_loaded 'abc/1.0'
check modules_loaded 'def/1.1'
check modules_loaded 'ghi/1.2'
check no_modules_inactive

blankline
run syz unload def/1.1
check success
check output_pattern 'Unloading' 'def/1.1'
check envvar_not_pattern 'SYZ_MODULES' 'def/1.1'
check envvar_not_pattern 'SYZ_MODULES_ABS' "$basedir"/sw/def/1.1
check envvar_not_pattern 'PATH' "$basedir"/sw/def/1.1/bin
check envvar_not_pattern 'LIBRARY_PATH' "$basedir"/sw/def/1.1/lib
check envvar_not_pattern 'LD_LIBRARY_PATH' "$basedir"/sw/def/1.1/lib
check envvar_not_pattern 'LD_RUN_PATH' "$basedir"/sw/def/1.1/lib

check modules_loaded 'abc/1.0'
check modules_not_loaded 'def/1.1'
check modules_loaded 'ghi/1.2'
check no_modules_inactive

blankline
run syz unload abc/1.0
check success
check output_pattern 'Unloading' 'abc/1.0'
check envvar_not_pattern 'SYZ_MODULES' 'abc/1.0'
check envvar_not_pattern 'SYZ_MODULES_ABS' "$basedir"/sw/abc/1.0
check envvar_not_pattern 'PATH' "$basedir"/sw/abc/1.0/bin
check envvar_not_pattern 'LIBRARY_PATH' "$basedir"/sw/abc/1.0/lib
check envvar_not_pattern 'LD_LIBRARY_PATH' "$basedir"/sw/abc/1.0/lib
check envvar_not_pattern 'LD_RUN_PATH' "$basedir"/sw/abc/1.0/lib

check modules_not_loaded 'abc/1.0'
check modules_not_loaded 'def/1.1'
check modules_loaded 'ghi/1.2'
check no_modules_inactive

blankline
run syz load def/1.1
check success
check output_pattern 'Loading' 'def/1.1'
check envvar_pattern 'SYZ_MODULES' 'def/1.1'
check envvar_pattern 'SYZ_MODULES_ABS' "$basedir"/sw/def/1.1
check envvar_pattern 'PATH' "$basedir"/sw/def/1.1/bin
check envvar_pattern 'LIBRARY_PATH' "$basedir"/sw/def/1.1/lib
check envvar_pattern 'LD_LIBRARY_PATH' "$basedir"/sw/def/1.1/lib
check envvar_pattern 'LD_RUN_PATH' "$basedir"/sw/def/1.1/lib

check modules_not_loaded 'abc/1.0'
check modules_loaded 'def/1.1'
check modules_loaded 'ghi/1.2'
check no_modules_inactive

blankline
run syz unload ghi/1.2
check success
check output_pattern 'Unloading' 'ghi/1.2'
check envvar_not_pattern 'SYZ_MODULES' 'ghi/1.2'
check envvar_not_pattern 'SYZ_MODULES_ABS' "$basedir"/sw/ghi/1.2
check envvar_not_pattern 'PATH' "$basedir"/sw/ghi/1.2/bin
check envvar_not_pattern 'LIBRARY_PATH' "$basedir"/sw/ghi/1.2/lib
check envvar_not_pattern 'LD_LIBRARY_PATH' "$basedir"/sw/ghi/1.2/lib
check envvar_not_pattern 'LD_RUN_PATH' "$basedir"/sw/ghi/1.2/lib

check modules_not_loaded 'abc/1.0'
check modules_loaded 'def/1.1'
check modules_not_loaded 'ghi/1.2'
check no_modules_inactive

blankline
run syz unload def/1.1
check success
check output_pattern 'Unloading' 'def/1.1'
check envvar_not_pattern 'SYZ_MODULES' 'def/1.1'
check envvar_not_pattern 'SYZ_MODULES_ABS' "$basedir"/sw/def/1.1
check envvar_not_pattern 'PATH' "$basedir"/sw/def/1.1/bin
check envvar_not_pattern 'LIBRARY_PATH' "$basedir"/sw/def/1.1/lib
check envvar_not_pattern 'LD_LIBRARY_PATH' "$basedir"/sw/def/1.1/lib
check envvar_not_pattern 'LD_RUN_PATH' "$basedir"/sw/def/1.1/lib

check modules_not_loaded 'abc/1.0'
check modules_not_loaded 'def/1.1'
check modules_not_loaded 'ghi/1.2'
check no_modules_loaded
check no_modules_inactive

blankline
run syz load ghi/1.2
check success
check output_pattern 'Loading' 'ghi/1.2'
check envvar_pattern 'SYZ_MODULES' 'ghi/1.2'
check envvar_pattern 'SYZ_MODULES_ABS' "$basedir"/sw/ghi/1.2
check envvar_pattern 'PATH' "$basedir"/sw/ghi/1.2/bin
check envvar_pattern 'LIBRARY_PATH' "$basedir"/sw/ghi/1.2/lib
check envvar_pattern 'LD_LIBRARY_PATH' "$basedir"/sw/ghi/1.2/lib
check envvar_pattern 'LD_RUN_PATH' "$basedir"/sw/ghi/1.2/lib

check modules_not_loaded 'abc/1.0'
check modules_not_loaded 'def/1.1'
check modules_loaded 'ghi/1.2'
check no_modules_inactive

blankline
run syz load ghi/1.2
check success
check output_pattern 'Module ghi/1.2 is already loaded, skipping'
check envvar_pattern 'SYZ_MODULES' 'ghi/1.2'
check envvar_pattern 'SYZ_MODULES_ABS' "$basedir"/sw/ghi/1.2
check envvar_pattern 'PATH' "$basedir"/sw/ghi/1.2/bin
check envvar_pattern 'LIBRARY_PATH' "$basedir"/sw/ghi/1.2/lib
check envvar_pattern 'LD_LIBRARY_PATH' "$basedir"/sw/ghi/1.2/lib
check envvar_pattern 'LD_RUN_PATH' "$basedir"/sw/ghi/1.2/lib

check modules_not_loaded 'abc/1.0'
check modules_not_loaded 'def/1.1'
check modules_loaded 'ghi/1.2'
check no_modules_inactive

# loading multiple modules on one cmdline
blankline
run syz load {abc/1.0,def/1.1}
check success
check output_pattern 'Loading' {abc/1.0,def/1.1}
check envvar_pattern 'SYZ_MODULES' {abc/1.0,def/1.1}
check envvar_pattern 'SYZ_MODULES_ABS' "$basedir"/sw/{abc/1.0,def/1.1}
check envvar_pattern 'PATH' "$basedir"/sw/{abc/1.0,def/1.1}/bin
check envvar_pattern 'LIBRARY_PATH' "$basedir"/sw/{abc/1.0,def/1.1}/lib
check envvar_pattern 'LD_LIBRARY_PATH' "$basedir"/sw/{abc/1.0,def/1.1}/lib
check envvar_pattern 'LD_RUN_PATH' "$basedir"/sw/{abc/1.0,def/1.1}/lib

check modules_loaded 'abc/1.0'
check modules_loaded 'def/1.1'
check modules_loaded 'ghi/1.2'
check no_modules_inactive

# unloading multiple modules on one cmdline
blankline
run syz unload {abc/1.0,def/1.1,ghi/1.2}
check success
check output_pattern 'Unloading' {abc/1.0,def/1.1,ghi/1.2}
check envvar_not_pattern 'SYZ_MODULES' {abc/1.0,def/1.1,ghi/1.2}
check envvar_not_pattern 'SYZ_MODULES_ABS' "$basedir"/sw/{abc/1.0,def/1.1,ghi/1.2}
check envvar_not_pattern 'PATH' "$basedir"/sw/{abc/1.0,def/1.1,ghi/1.2}/bin
check envvar_not_pattern 'LIBRARY_PATH' "$basedir"/sw/{abc/1.0,def/1.1,ghi/1.2}/lib
check envvar_not_pattern 'LD_LIBRARY_PATH' "$basedir"/sw/{abc/1.0,def/1.1,ghi/1.2}/lib
check envvar_not_pattern 'LD_RUN_PATH' "$basedir"/sw/{abc/1.0,def/1.1,ghi/1.2}/lib

check modules_not_loaded 'abc/1.0'
check modules_not_loaded 'def/1.1'
check modules_not_loaded 'ghi/1.2'
check no_modules_loaded
check no_modules_inactive

# trying to load module with unknown package name
blankline
run syz load xyz/0.9
check failure
check output_pattern 'No such module: xyz/0.9'
check envvar_not_pattern 'SYZ_MODULES' 'xyz/0.9'
check envvar_not_pattern 'SYZ_MODULES_ABS' "$basedir"/sw/xyz/0.9
check envvar_not_pattern 'PATH' "$basedir"/sw/xyz/0.9/bin
check envvar_not_pattern 'LIBRARY_PATH' "$basedir"/sw/xyz/0.9/lib
check envvar_not_pattern 'LD_LIBRARY_PATH' "$basedir"/sw/xyz/0.9/lib
check envvar_not_pattern 'LD_RUN_PATH' "$basedir"/sw/xyz/0.9/lib

check modules_not_loaded 'abc/1.0'
check modules_not_loaded 'def/1.1'
check modules_not_loaded 'ghi/1.2'
check modules_not_loaded 'xyz/0.9'
check no_modules_loaded
check no_modules_inactive

# trying to load module with unknown package name
blankline
run syz load xyz
check failure
check output_pattern 'No such module: xyz'
check envvar_not_pattern 'SYZ_MODULES' 'xyz'
check envvar_not_pattern 'SYZ_MODULES_ABS' "$basedir"/sw/xyz
check envvar_not_pattern 'PATH' "$basedir"/sw/xyz/bin
check envvar_not_pattern 'LIBRARY_PATH' "$basedir"/sw/xyz/lib
check envvar_not_pattern 'LD_LIBRARY_PATH' "$basedir"/sw/xyz/lib
check envvar_not_pattern 'LD_RUN_PATH' "$basedir"/sw/xyz/lib

check modules_not_loaded 'abc/1.0'
check modules_not_loaded 'def/1.1'
check modules_not_loaded 'ghi/1.2'
check modules_not_loaded 'xyz'
check no_modules_loaded
check no_modules_inactive

# trying to load module with unknown version
blankline
run syz load abc/0.9
check failure
check output_pattern 'No such module: abc/0.9'
check envvar_not_pattern 'SYZ_MODULES' 'abc/0.9'
check envvar_not_pattern 'SYZ_MODULES_ABS' "$basedir"/sw/abc/0.9
check envvar_not_pattern 'PATH' "$basedir"/sw/abc/0.9/bin
check envvar_not_pattern 'LIBRARY_PATH' "$basedir"/sw/abc/0.9/lib
check envvar_not_pattern 'LD_LIBRARY_PATH' "$basedir"/sw/abc/0.9/lib
check envvar_not_pattern 'LD_RUN_PATH' "$basedir"/sw/abc/0.9/lib

check modules_not_loaded 'abc/1.0'
check modules_not_loaded 'def/1.1'
check modules_not_loaded 'ghi/1.2'
check modules_not_loaded 'abc/0.9'
check no_modules_loaded
check no_modules_inactive

# unload module which is known but not loaded
blankline
run syz unload abc/1.0
check success
check output_pattern 'Error: No module named abc/1.0 is loaded'
check envvar_not_pattern 'SYZ_MODULES' abc/1.0
check envvar_not_pattern 'SYZ_MODULES_ABS' "$basedir"/sw/abc/1.0
check envvar_not_pattern 'PATH' "$basedir"/sw/abc/1.0/bin
check envvar_not_pattern 'LIBRARY_PATH' "$basedir"/sw/abc/1.0/lib
check envvar_not_pattern 'LD_LIBRARY_PATH' "$basedir"/sw/abc/1.0/lib
check envvar_not_pattern 'LD_RUN_PATH' "$basedir"/sw/abc/1.0/lib

check modules_not_loaded 'abc/1.0'
check modules_not_loaded 'def/1.1'
check modules_not_loaded 'ghi/1.2'
check no_modules_loaded
check no_modules_inactive

# unload module with unknown package name
blankline
run syz unload xyz/0.9
check success
check output_pattern 'Error: No module named xyz/0.9 is loaded'
check envvar_not_pattern 'SYZ_MODULES' xyz/0.9
check envvar_not_pattern 'SYZ_MODULES_ABS' "$basedir"/sw/xyz/0.9
check envvar_not_pattern 'PATH' "$basedir"/sw/xyz/0.9/bin
check envvar_not_pattern 'LIBRARY_PATH' "$basedir"/sw/xyz/0.9/lib
check envvar_not_pattern 'LD_LIBRARY_PATH' "$basedir"/sw/xyz/0.9/lib
check envvar_not_pattern 'LD_RUN_PATH' "$basedir"/sw/xyz/0.9/lib

check modules_not_loaded 'abc/1.0'
check modules_not_loaded 'def/1.1'
check modules_not_loaded 'ghi/1.2'
check modules_not_loaded 'xyz/0.9'
check no_modules_loaded
check no_modules_inactive

# unload module with unknown package name
blankline
run syz unload xyz
check success
check output_pattern 'Error: No module named xyz is loaded'
check envvar_not_pattern 'SYZ_MODULES' xyz
check envvar_not_pattern 'SYZ_MODULES_ABS' "$basedir"/sw/xyz
check envvar_not_pattern 'PATH' "$basedir"/sw/xyz/bin
check envvar_not_pattern 'LIBRARY_PATH' "$basedir"/sw/xyz/lib
check envvar_not_pattern 'LD_LIBRARY_PATH' "$basedir"/sw/xyz/lib
check envvar_not_pattern 'LD_RUN_PATH' "$basedir"/sw/xyz/lib

check modules_not_loaded 'abc/1.0'
check modules_not_loaded 'def/1.1'
check modules_not_loaded 'ghi/1.2'
check modules_not_loaded 'xyz'
check no_modules_loaded
check no_modules_inactive

# unload module with unknown version
blankline
run syz unload abc/0.9
check success
check output_pattern 'Error: No module named abc/0.9 is loaded'
check envvar_not_pattern 'SYZ_MODULES' abc/0.9
check envvar_not_pattern 'SYZ_MODULES_ABS' "$basedir"/sw/abc/0.9
check envvar_not_pattern 'PATH' "$basedir"/sw/abc/0.9/bin
check envvar_not_pattern 'LIBRARY_PATH' "$basedir"/sw/abc/0.9/lib
check envvar_not_pattern 'LD_LIBRARY_PATH' "$basedir"/sw/abc/0.9/lib
check envvar_not_pattern 'LD_RUN_PATH' "$basedir"/sw/abc/0.9/lib

check modules_not_loaded 'abc/1.0'
check modules_not_loaded 'def/1.1'
check modules_not_loaded 'ghi/1.2'
check modules_not_loaded 'abc/0.9'
check no_modules_loaded
check no_modules_inactive

# FIXME: add some pathological cases around strange/unexpected characters in filenames
# especially space, dot, comma, colon
# in both the base dir which is in the $SYZ_PATH, and the package dir, and the version

# fin
blankline
